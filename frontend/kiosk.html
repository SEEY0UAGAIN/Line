<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kiosk QR Scan (Debug Mode)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #f4f6ff;
    }
    #preview {
      width: 420px;
      height: 420px;
      margin: auto;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      background: #000;
    }
    #qr-result {
      margin-top: 20px;
      font-size: 1.1em;
      color: #333;
      white-space: pre-wrap;
    }
    #debug-box {
      margin-top: 20px;
      width: 80%;
      max-width: 700px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      margin-left: auto;
      margin-right: auto;
      font-family: monospace;
      font-size: 0.9em;
      white-space: pre-wrap;
      color: #333;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 15px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #4a6cf7;
      color: white;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: #3650d4;
    }
  </style>
</head>
<body>
  <h1>Kiosk - ‡∏™‡πÅ‡∏Å‡∏ô QR Code</h1>

  <div id="preview"></div>
  <div id="qr-result">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô QR Code...</div>

  <button id="restart-btn" style="display:none;">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>

  <!-- üîç Debug Panel -->
  <div id="debug-box">[DEBUG] Waiting for scan...</div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

  <script>
    const resultElem = document.getElementById('qr-result');
    const debugBox = document.getElementById('debug-box');
    const restartBtn = document.getElementById('restart-btn');
    let html5QrCode;

    // üîç ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° debug
    function debugLog(label, data) {
      const time = new Date().toLocaleTimeString();
      debugBox.innerText += `\n[${time}] ${label}: ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
    }

    async function startScanner() {
      resultElem.innerText = "üì∑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
      restartBtn.style.display = "none";
      debugLog("Scanner", "Starting camera...");

      html5QrCode = new Html5Qrcode("preview");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 350 },
        qrCodeMessage => {
          debugLog("QR Detected", qrCodeMessage);
          resultElem.innerText = `QR Code Detected!`;
          html5QrCode.stop();
          processQRCode(qrCodeMessage);
        },
        errorMessage => { /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á log ‡∏ã‡πâ‡∏≥ */ }
      ).catch(err => {
        debugLog("Camera error", err);
        resultElem.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + err;
      });
    }

    async function processQRCode(token) {
      debugLog("Process", "Decoding token...");
      let decoded = null;

      try {
        decoded = jwt_decode(token);
        debugLog("Decoded QR", decoded);
      } catch (err) {
        resultElem.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ QR ‡πÑ‡∏î‡πâ";
        debugLog("Decode Error", err.message);
        restartBtn.style.display = "block";
        return;
      }

      // üß© ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const displayName = decoded.name && decoded.name.trim() !== "" ? decoded.name : "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô QR Code)";
      const displayCid = decoded.cid || "(‡πÑ‡∏°‡πà‡∏°‡∏µ cid)";
      const displayRight = decoded.right_name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô QR)";
      const displayLineId = decoded.line_user_id ? "‚úÖ " + decoded.line_user_id : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ line_user_id";
      const displayDob = decoded.dob ? decoded.dob : "‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î";

      resultElem.innerText = 
        `‚úÖ ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
        `‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢: ${displayName}\n` +
        `CID: ${displayCid}\n` +
        `‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${displayRight}\n` +
        `Line ID: ${displayLineId}\n` +
        `‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î: ${displayDob}\n\n` +
        `üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≤‡∏Å Token:\n` +
        JSON.stringify(decoded, null, 2);

      debugLog("Info", "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ API)");
      restartBtn.style.display = "block";
    }

    restartBtn.addEventListener('click', () => {
      debugLog("Action", "Restart scanner");
      startScanner();
    });

    startScanner();
  </script>
</body>
</html>
